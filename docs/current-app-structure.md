# PerfDB アプリケーション構造ドキュメント

## 📋 概要

PerfDBは、テニス選手のパフォーマンス向上とケガ予防のためのトレーニング管理システムです。

## 🏗️ アーキテクチャ

### フロントエンド構造

Next.js 13+ App Routerを使用し、**Route Groups**でユーザーインターフェースを分離しています。

```
frontend/src/app/
├── (auth)/              # 認証ページ（ヘッダー/フッターなし）
│   ├── layout.tsx       # 認証専用レイアウト
│   ├── login/           # ログインページ
│   └── signup/          # サインアップページ
│
├── (user)/              # ユーザー向けページ（ヘッダー/フッターあり）
│   ├── layout.tsx       # ユーザー専用レイアウト（ページ遷移アニメーション付き）
│   ├── page.tsx         # ホームページ（ダッシュボード）
│   ├── training/        # トレーニング関連
│   │   ├── warmup/      # ウォームアップ
│   │   ├── cooldown/    # クールダウン
│   │   ├── core/        # 体幹トレーニング
│   │   └── flexibility/ # 柔軟性チェック
│   ├── mypage/          # マイページ
│   ├── karte/           # トレーニングカルテ
│   └── quickstart/      # クイックスタート
│
└── admin/               # 管理画面（サイドバー付き）
    ├── layout.tsx       # 管理画面専用レイアウト
    ├── page.tsx         # 管理画面ダッシュボード
    ├── training-evaluations/  # トレーニング評価管理
    ├── test-results/    # テスト結果管理
    └── physical-test-results/ # テスト結果表示
```

## 🗺️ ルーティング構造

### 公開ページ（認証不要）

| URL | 説明 | レイアウト |
|-----|------|-----------|
| `/` | ホームページ（ダッシュボード） | User Layout |
| `/about` | アバウトページ | User Layout |
| `/contact` | お問い合わせページ | User Layout |

### 認証ページ

| URL | 説明 | レイアウト |
|-----|------|-----------|
| `/login` | ログインページ | Auth Layout（ヘッダー/フッターなし） |
| `/signup` | サインアップページ | Auth Layout（ヘッダー/フッターなし） |

### ユーザーページ（認証推奨）

| URL | 説明 | 認証 |
|-----|------|------|
| `/mypage/[userId]` | マイページ | 推奨 |
| `/karte/[userId]` | トレーニングカルテ | 推奨 |
| `/quickstart` | クイックスタートガイド | 必須 |

### トレーニングページ

| URL | 説明 | 認証 |
|-----|------|------|
| `/training/warmup` | ウォームアップ一覧 | 不要 |
| `/training/warmup/[id]` | ウォームアップ詳細 | 不要 |
| `/training/cooldown` | クールダウン一覧 | 不要 |
| `/training/cooldown/[id]` | クールダウン詳細 | 不要 |
| `/training/core` | 体幹トレーニング一覧 | 不要 |
| `/training/core/[id]` | 体幹トレーニング詳細 | 不要 |
| `/training/flexibility` | 柔軟性チェック一覧 | 不要 |
| `/training/flexibility/[id]` | 柔軟性チェック詳細 | 不要 |

### 管理画面（管理者のみ）

| URL | 説明 | 認証 |
|-----|------|------|
| `/admin` | 管理画面ダッシュボード | 管理者必須 |
| `/admin/training-evaluations` | トレーニング評価管理 | 管理者必須 |
| `/admin/test-results` | テスト結果管理 | 管理者必須 |
| `/admin/physical-test-results/[userId]` | テスト結果表示 | 管理者必須 |

## 🔄 ページ遷移フロー

### ユーザーフロー

```
1. ホームページ (/)
   ├─> トレーニングカテゴリを選択
   │   ├─> /training/warmup
   │   ├─> /training/cooldown
   │   ├─> /training/core
   │   └─> /training/flexibility
   │       └─> /training/[category]/[id] (詳細ページ)
   │
   ├─> マイページへ
   │   └─> /mypage/[userId]
   │
   ├─> クイックスタート
   │   └─> /quickstart
   │
   └─> ログイン/サインアップ
       ├─> /login
       └─> /signup
```

### 管理画面フロー

```
/admin
├─> /admin/training-evaluations (トレーニング評価管理)
├─> /admin/test-results (テスト結果管理)
└─> /admin/physical-test-results/[userId] (テスト結果表示)
```

## 🎨 レイアウト構造

### 1. Auth Layout (`(auth)/layout.tsx`)
- **特徴**: ヘッダー/フッターなし、シンプルな認証画面
- **適用ページ**: `/login`, `/signup`

### 2. User Layout (`(user)/layout.tsx`)
- **特徴**: 
  - ヘッダー/フッターあり
  - ページ遷移アニメーション（フェードイン/アウト）
  - 共通ナビゲーション
- **適用ページ**: すべてのユーザー向けページ

### 3. Admin Layout (`admin/layout.tsx`)
- **特徴**:
  - サイドバー付き
  - ヘッダー/フッターあり
  - 管理者認証チェック
- **適用ページ**: すべての管理画面ページ

## 🧩 主要コンポーネント

### 共通コンポーネント (`components/common/`)

| コンポーネント | 説明 |
|--------------|------|
| `Header.tsx` | サイトヘッダー（ロゴ、ナビゲーション） |
| `Footer.tsx` | サイトフッター |
| `Container.tsx` | コンテナコンポーネント |
| `Toast.tsx` | トースト通知システム |
| `ImageWithFallback.tsx` | 画像エラーハンドリング付き画像コンポーネント |
| `LoadingSpinner.tsx` | ローディングスピナー |

### 管理画面コンポーネント (`components/admin/`)

| コンポーネント | 説明 |
|--------------|------|
| `AdminSidebar.tsx` | 管理画面サイドバー |
| `UserForm.tsx` | ユーザー作成フォーム |
| `UserList.tsx` | ユーザー一覧 |
| `ResultForm.tsx` | テスト結果作成フォーム |
| `ResultList.tsx` | テスト結果一覧 |
| `PhysicalTestResults.tsx` | テスト結果表示 |

## 🔌 API統合

### APIクライアント (`utils/apiClient.ts`)

- **リトライ機能**: 最大3回、指数バックオフ
- **タイムアウト**: 30秒
- **エラーハンドリング**: ネットワークエラーと5xxエラーで自動リトライ

### カスタムフック (`hooks/`)

| フック | 説明 |
|--------|------|
| `useFlexibilityChecks.ts` | トレーニングデータ取得フック |
| `useAuth.ts` | 認証状態管理 |
| `useAdminAuth.ts` | 管理者認証チェック |

## 📱 ホームページ（ダッシュボード）機能

### 主要セクション

1. **ウェルカムメッセージ**
   - 認証済みユーザー名表示

2. **クイックアクセス**
   - 続きから始める（進行中のトレーニング）
   - マイページへのリンク

3. **トレーニングカテゴリ**
   - ウォームアップ（オレンジ/赤）
   - 体幹トレーニング（青/インディゴ）
   - 柔軟性チェック（緑/エメラルド）
   - クールダウン（紫/青）

4. **進捗サマリー**
   - 評価済みトレーニング数
   - カテゴリ別の進捗状況

5. **最近の活動**
   - 最近実施したトレーニングの一覧

## 🎯 主要機能

### トレーニング機能

- **4つのトレーニングタイプ**:
  1. ウォームアップ (WARMUP)
  2. クールダウン (COOLDOWN)
  3. 体幹トレーニング (CORE)
  4. 柔軟性チェック (FLEXIBILITY)

- **各トレーニングページ**:
  - 一覧ページ: カード形式で表示
  - 詳細ページ: 画像、説明、タイマー、評価機能

### 評価システム

- **評価レベル**:
  - 1: 要改善
  - 2: 達成
  - 3: 優秀
  - 4: 開始済み

### 管理機能

- ユーザー管理
- テスト結果管理
- トレーニング評価管理

## 🔐 認証・認可

### 認証方式
- ローカルストレージベース（`userId`を保存）
- UUID形式のユーザーID

### 認可レベル
1. **一般ユーザー**: トレーニング閲覧、自分のデータ管理
2. **管理者**: 全機能へのアクセス

## 🎨 UI/UX特徴

### デザインシステム
- **フレームワーク**: Tailwind CSS
- **コンポーネント**: shadcn/ui
- **アニメーション**: ページ遷移フェード効果

### レスポンシブデザイン
- モバイルファースト
- デスクトップ/タブレット/モバイル対応

### アクセシビリティ
- アイコン付きナビゲーション
- キーボードナビゲーション対応

## 📊 データフロー

```
ユーザー操作
  ↓
Next.js ページコンポーネント
  ↓
カスタムフック (useFlexibilityChecks, etc.)
  ↓
APIクライアント (apiClient)
  ↓
バックエンド API (FastAPI)
  ↓
データベース (PostgreSQL)
```

## 🚀 パフォーマンス最適化

1. **画像最適化**
   - Next.js Image コンポーネント
   - エラーハンドリングとフォールバック

2. **ローディング状態**
   - 統一されたローディングスピナー
   - スケルトンUI

3. **API呼び出し**
   - リトライ機能
   - タイムアウト延長
   - エラーハンドリング

## 📝 今後の改善予定

- [ ] トレーニング詳細ページの共通化（コード重複削減）
- [ ] 型安全性の向上
- [ ] アクセシビリティの向上
- [ ] パフォーマンス最適化（画像の遅延読み込み）
- [ ] 管理者認証の実装（Firebaseカスタムクレーム）
- [ ] エラーバウンダリーの追加
- [ ] テストの追加

